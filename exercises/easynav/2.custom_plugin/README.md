# Exercise 2 - Add Custom Plugin

To create a custom plugin in EasyNav, you simply need to design your own update and update_rt functions. Within these functions, you decide what information to read from or write to the NavState blackboard. This gives you full flexibility to implement your desired logic and share data between modules.

NavState implements a shared blackboard pattern, enabling all modules, such as localizers, planners, and controllers; to exchange data directly without relying on ROS 2 communication mechanisms internally.

All information used or generated by EasyNav modules passes through NavState. Typical examples include:
- The robotâ€™s estimated pose: `robot_pose`
- A list of navigation goals: `goals`
- The planned path to follow: `path`
- Environment maps: `map`, `map.static`, `map.dynamic`
- Control commands: `cmd_vel`


## Accessing data in NavState
This exercise is focused on accessing data in the blackboard. To check if a value is available:
```cpp
if (nav_state.has("robot_pose")) {
  // do something
}
``

To read a value, use the templated get method:
```cpp
 const auto goals = nav_state.get<nav_msgs::msg::Goals>("goals");
```

To write a value:
```cpp
nav_state.set("cmd_vel", computed_twist);
```

All values are stored under a string key and must be copyable.
You can store standard ROS messages, custom types, or even nested structures.


## Custom type printers
Another interesting aspect of NavState is custom printers, which provide a way to visualize custom types in debug output. In this exercise, we register a printer for our `PathInfo` type:

```cpp
NavState::register_printer<PathInfo>(
  [](const PathInfo &value)
  {
    std::ostringstream oss;
    oss << "Generated linear path:\n"
        << "  Origin: (" << std::fixed << std::setprecision(2)
        << value.origin.x << ", " << value.origin.y << ", " << value.origin.z << ")\n"
        << "  Radius: " << std::fixed << std::setprecision(2) << value.radius << " m\n"
        << "  Waypoints: " << value.num_waypoints;
    return oss.str();
  });
```

This printer is automatically used when logging NavState contents, providing formatted output for debugging and monitoring.


## Exercise

For this exercise, you will work on a plugin designed to generate a linear path based on the robot's current pose, and a defined number of waypoints. These tasks involve interacting with the NavState blackboard to depict and store data using the following structure:

```cpp
  struct PathInfo
  {
    geometry_msgs::msg::Point origin;
    double radius;
    int num_waypoints;
  };
```

## Add you plugin to your config file
To use your custom plugin in EasyNav, you need to declare it in your configuration YAML file. This tells the system which planner types are available and how to load your plugin with its parameters.

Below is an example of how to add your plugin to the configuration:
```yaml
planner_node:
  ros__parameters:
    use_sim_time: true
    planner_types: [<your_type>]  # List all planner types you want to use
    <your_type>:                  # This key should match the type in planner_types
      plugin: <your_registered_plugin>  # The name you registered your plugin with
      <plugin_parameter_1>: <value_1>   # Any parameters your plugin needs
      <plugin_parameter_2>: <value_2>
      # Add more parameters as needed
```
This setup ensures your custom plugin is loaded and configured with the parameters you need for your navigation scenario.

## Execution

1. Build the package:
 ```bash
colcon build --packages-select easynav_workshop_planner
```
2. Source the setup file:
```bash
source install/setup.bash
```
3. Launch the Kobuki playground. We can use it without graphic interface:
```bash
ros2 launch easynav_playground_kobuki playground_kobuki.launch.py gui:=false
```

4. Start EasyNav with this exercise params:
```bash
ros2 run easynav_system system_main --ros-args --params-file ~/workshop_ws/src/exercises/easynav/easynav_playground/easynav_workshop_testcase/config/custom.params.yaml 
```

5. Start RViz (use simulation time):
```bash
ros2 run rviz2 rviz2 -d ~/workshop_ws/src/exercises/easynav/easynav_playground/easynav_workshop_testcase/rviz/costmap.rviz 
```

Check all information from the path is provided both in the logger of the `easynav_system` terminal and the TUI.